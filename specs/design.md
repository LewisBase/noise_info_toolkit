# FastAPI+Streamlit 架构设计方案（无WebSocket）

## 概述

本方案旨在设计一个完全弃用WebSocket的FastAPI+Streamlit架构，用于监控指定文件夹中的TDMS音频文件，将其转换为WAV格式，并计算LAeq、峰度等声学参数。通过HTTP轮询机制实现前后端通信，满足分钟级实时性要求。

## 技术架构

### 整体架构
```
┌─────────────────┐    监控文件夹      ┌──────────────────┐
│   TDMS文件       ├──────────────────►│   文件监控模块     │
└─────────────────┘                   └─────────┬────────┘
                                               │
                                               ▼
┌─────────────────┐                   ┌──────────────────┐
│   WAV文件       ◄───────────────────┤   TDMS转换模块     │
└─────────────────┘                   └─────────┬────────┘
                                               │
                                               ▼
┌─────────────────┐                   ┌──────────────────┐
│  SQLite数据库    ◄───────────────────┤   音频处理模块     │
└─────────────────┘                   └─────────┬────────┘
                                               │
         │                                     │
         ▼                                     ▼
┌─────────────────┐                   ┌──────────────────┐
│  Streamlit前端   ├───────────────────►│   FastAPI后端     │
│   (轮询获取数据)  │    HTTP请求        │   (提供API接口)   │
└─────────────────┘                   └──────────────────┘
```

### 技术选型
- **后端框架**: FastAPI
- **前端框架**: Streamlit
- **文件监控**: watchdog
- **音频处理**: librosa, numpy, scipy
- **数据存储**: SQLite数据库（持久化存储，避免内存泄漏）
- **通信机制**: HTTP轮询（替代WebSocket）

## 组件设计

### 1. 后端组件

#### 1.1 文件监控模块 (`app/core/file_monitor.py`)
- 使用watchdog库监控指定目录
- 监听`.tdms`和`.wav`文件的创建事件
- 触发文件处理回调函数

#### 1.2 TDMS转换模块 (`app/core/tdms_converter.py`)
- 将TDMS格式文件转换为WAV格式
- 提取采样率等元数据信息
- 保证转换后的文件能被音频处理模块正确读取
- 转换生成的临时WAV文件在音频处理完成并存储到数据库后自动删除，以节省磁盘空间

#### 1.3 音频处理模块 (`app/core/audio_processor.py`)
- 计算Leq, LAeq, LCeq等声学参数
- 分析1/3倍频程频谱
- 计算峰度等统计特征

#### 1.4 任务管理模块 (`app/core/background_tasks.py`)
- 管理文件监控和处理流程
- 协调各模块间的数据流转
- 提供处理完成后的回调机制

#### 1.5 数据存储模块 (`app/database/`)
- 使用SQLite数据库持久化存储处理结果
- 提供API端点供前端查询最新和历史数据
- 实现数据清理机制，避免数据库无限增长

### 2. 前端组件

#### 2.1 轮询机制 (`streamlit_app.py`)
- 定期向后端发送HTTP请求获取最新数据
- 更新界面显示各项声学指标
- 维护历史数据用于趋势展示

#### 2.2 界面展示
- 实时监控面板：显示当前处理文件及结果
- 历史数据面板：展示历史记录和趋势图
- 系统状态面板：显示后端服务状态

## 数据模型

### SQLite数据库表结构

#### 处理结果表 (processing_results)
| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| file_path | TEXT | 原始文件路径 |
| timestamp | DATETIME | 处理时间戳 |

#### 处理指标表 (processing_metrics)
| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| result_id | INTEGER | 外键，关联processing_results.id |
| metric_name | TEXT | 指标名称 (如leq, laeq, lceq, peak_spl, kurtosis等) |
| metric_value | REAL | 指标值 |
| metric_type | TEXT | 指标类型 (数值型/频谱型等) |

#### 频谱数据表 (spectrum_data)
| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| metric_id | INTEGER | 外键，关联processing_metrics.id |
| frequency | TEXT | 频率 (如"63", "125"等) |
| value | REAL | 对应频率的声压级值 |

#### 数据库配置表 (config)
| 字段名 | 类型 | 描述 |
|--------|------|------|
| key | TEXT | 配置项键名 |
| value | TEXT | 配置项值 |
| updated_at | DATETIME | 最后更新时间 |

## API规范

### 1. 获取健康状态
```
GET /health
响应:
{
  "status": "healthy",
  "monitoring": true
}
```

### 2. 获取最新处理结果
```
GET /latest-metrics
响应:
{
  "id": 1,
  "file_path": "audio_files/recording_001.wav",
  "timestamp": "2023-01-01T12:00:00Z",
  "metrics": {
    "leq": 65.2,
    "laeq": 63.8,
    "lceq": 67.1,
    "peak_spl": 78.5,
    "kurtosis": 2.8,
    "frequency_spl": {
      "63": 55.2,
      "125": 58.7,
      "250": 62.1,
      "500": 65.3,
      "1000": 63.8,
      "2000": 59.2,
      "4000": 52.7,
      "8000": 48.3,
      "16000": 42.1
    }
  }
}
```

### 3. 获取历史处理结果
```
GET /history-metrics
参数:
- limit (可选): 返回记录数限制，默认50
- offset (可选): 偏移量，默认0

响应:
[
  {
    "id": 1,
    "file_path": "audio_files/recording_001.wav",
    "timestamp": "2023-01-01T12:00:00Z",
    "metrics": {
      "leq": 65.2,
      "laeq": 63.8,
      "lceq": 67.1,
      "peak_spl": 78.5,
      "kurtosis": 2.8,
      "frequency_spl": {
        "63": 55.2,
        "125": 58.7,
        "250": 62.1,
        "500": 65.3,
        "1000": 63.8,
        "2000": 59.2,
        "4000": 52.7,
        "8000": 48.3,
        "16000": 42.1
      }
    }
  },
  {
    "id": 2,
    "file_path": "audio_files/recording_002.wav",
    "timestamp": "2023-01-01T12:01:00Z",
    "metrics": {
      "leq": 64.8,
      "laeq": 63.2,
      "lceq": 66.9,
      "peak_spl": 77.8,
      "kurtosis": 2.9,
      "frequency_spl": {
        "63": 54.8,
        "125": 58.2,
        "250": 61.7,
        "500": 64.9,
        "1000": 63.4,
        "2000": 58.9,
        "4000": 52.3,
        "8000": 47.9,
        "16000": 41.8
      }
    }
  }
]
```

### 4. 清理历史数据
```
DELETE /cleanup-history
参数:
- days_old (可选): 保留天数，默认30天

响应:
{
  "deleted_count": 15,
  "message": "成功删除15条历史记录"
}
```

## 错误处理策略

1. **文件处理错误**：
   - 记录日志并继续监控
   - 返回错误信息给API调用方

2. **网络通信错误**：
   - Streamlit前端在网络请求失败时显示错误提示
   - 自动重试机制

3. **资源不足错误**：
   - 限制同时处理的文件数量
   - 实现队列机制处理大量文件

## 测试策略

1. **单元测试**：
   - TDMS转WAV功能测试
   - 音频处理算法准确性测试
   - API端点响应测试

2. **集成测试**：
   - 文件监控到处理完整流程测试
   - 前后端数据传输测试

3. **性能测试**：
   - 并发文件处理能力测试
   - 内存占用监控

## 实现注意事项

1. **线程安全**：确保多线程环境下数据访问的安全性
2. **数据库管理**：合理设计数据库表结构，建立适当的索引以提高查询效率
3. **临时文件处理**：TDMS转换生成的WAV文件应在音频处理完成并存储到数据库后才删除，避免处理失败时丢失数据
4. **异常恢复**：服务重启后能够继续监控文件夹，并处理未完成的任务
5. **数据清理机制**：定期清理过期的历史数据，避免数据库无限增长
6. **扩展性设计**：采用纵表结构存储指标数据，便于后续添加新的声学指标